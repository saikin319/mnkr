<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>オンラインゲーム</title>
<style>
canvas { background: #ccc; display:block; margin: 0 auto; }
#chat { width: 500px; margin: 10px auto; }
#messages { border: 1px solid #999; height: 150px; overflow-y: scroll; padding: 5px; background: #fff; }
#input { width: 100%; }
</style>
</head>
<body>
<canvas id="game" width="500" height="500"></canvas>

<div id="chat">
    <div id="messages"></div>
    <input id="input" autocomplete="off" placeholder="チャット入力" />
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io(); // 自動で同一ドメインに接続
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const players = {};

let myName = prompt("名前を入力してください") || '名無し';
socket.emit('setName', myName);

const keysPressed = {}; // 押されているキー

document.addEventListener('keydown', (e) => {
    if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) {
        keysPressed[e.key] = true;
        e.preventDefault();
    }
});
document.addEventListener('keyup', (e) => {
    if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) {
        keysPressed[e.key] = false;
        e.preventDefault();
    }
});

// チャット送信
const input = document.getElementById('input');
const messages = document.getElementById('messages');
input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && input.value) {
        socket.emit('chatMessage', input.value);
        input.value = '';
    }
});

// チャット受信
socket.on('chatMessage', ({ name, msg }) => {
    const div = document.createElement('div');
    div.textContent = `${name}: ${msg}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
});

// プレイヤー情報同期
socket.on('currentPlayers', (data) => Object.assign(players, data));
socket.on('newPlayer', (data) => players[data.id] = { x: data.x, y: data.y, color: data.color, name: data.name });
socket.on('playerMoved', (data) => { if(players[data.id]) { players[data.id].x = data.x; players[data.id].y = data.y; } });
socket.on('playerDisconnected', (id) => delete players[id]);

// 押しっぱなしで滑らか移動
function handleMovement() {
    if (!players[socket.id]) return;

    let dir = null;
    if (keysPressed['ArrowLeft']) dir = 'left';
    else if (keysPressed['ArrowRight']) dir = 'right';
    else if (keysPressed['ArrowUp']) dir = 'up';
    else if (keysPressed['ArrowDown']) dir = 'down';

    if (dir) socket.emit('move', dir);
}

// 描画ループ
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // 壁表示
    ctx.fillStyle = '#444';
    ctx.fillRect(0,0,500,10); // 上
    ctx.fillRect(0,490,500,10); // 下
    ctx.fillRect(0,0,10,500); // 左
    ctx.fillRect(490,0,10,500); // 右

    // プレイヤー描画
    for (const id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 20, 20);

        // 名前表示（キャラ下中央）
        ctx.fillStyle = '#000';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(p.name, p.x + 10, p.y + 30);
    }

    handleMovement();
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
